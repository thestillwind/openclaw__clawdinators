#!/usr/bin/env bash
set -euo pipefail

instance_name="${instance_name}"
bootstrap_prefix="${bootstrap_prefix}"
flake_host="${flake_host}"
control_api_url="${control_api_url}"

install -d -m 0755 /etc/clawdinator
printf '%s' "${instance_name}" > /etc/clawdinator/instance-name
printf '%s' "${bootstrap_prefix}" > /etc/clawdinator/bootstrap-prefix
if [ -n "${control_api_url}" ]; then
  printf '%s' "${control_api_url}" > /etc/clawdinator/control-api-url
fi

systemctl stop clawdinator.service || true
systemctl daemon-reload

wait_for_service() {
  local service="$1"
  local timeout=300
  local waited=0
  local state
  local result
  local start_ts

  if [ "$#" -ge 2 ]; then
    timeout="$2"
  fi

  systemctl start "$service"
  while true; do
    state="$(systemctl show -p ActiveState --value "$service")"
    result="$(systemctl show -p Result --value "$service")"
    start_ts="$(systemctl show -p ExecMainStartTimestampMonotonic --value "$service")"

    if [ "$state" = "active" ]; then
      return 0
    fi
    if [ "$state" = "inactive" ] && [ "$result" = "success" ] && [ "$start_ts" != "0" ]; then
      return 0
    fi
    if [ "$state" = "failed" ] || [ "$result" = "exit-code" ] || [ "$result" = "timeout" ] || [ "$result" = "failed" ]; then
      systemctl status "$service" --no-pager
      return 1
    fi
    if [ "$waited" -ge "$timeout" ]; then
      echo "Timed out waiting for $service" >&2
      systemctl status "$service" --no-pager
      return 1
    fi
    sleep 2
    waited=$((waited + 2))
  done
}

wait_for_service "clawdinator-bootstrap.service" 300
wait_for_service "clawdinator-repo-seed.service" 300

if [ ! -d /var/lib/clawd/repos/clawdinators ]; then
  echo "clawdinator repo missing after bootstrap" >&2
  exit 1
fi

nixos-rebuild switch --flake /var/lib/clawd/repos/clawdinators#${flake_host}
